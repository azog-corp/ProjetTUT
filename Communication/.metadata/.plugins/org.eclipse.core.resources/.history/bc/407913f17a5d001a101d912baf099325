package nvProjet;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.SocketException;
import java.util.ArrayList;

public class Serveur {
	/** Liste desclients a traiter */
	static ArrayList<Client> listeClient = new ArrayList<Client>();
	static DatagramSocket socket; 
	static byte[] buffer;
	static String message;
	static DatagramPacket paquet;
	static int comptThread;
	
	

	public static ArrayList<Client> getListeClient() {
		return listeClient;
	}

	public static void setListeClient(ArrayList<Client> listeClient) {
		Serveur.listeClient = listeClient;
	}
	public static void setClient(int index,Client element) {
		Serveur.listeClient.set(index, element);
	}
	

	public static void main(String[] args) {
		System.out.println("Serveur lancé !");
		int compteur = 0;
		try {
			socket = new DatagramSocket(4523);
		} catch (SocketException e1) {
			
		} 
		traiterClient();
		while(true) {
			try {
				buffer = new byte[100];
				paquet = new DatagramPacket(buffer,100);
				socket.receive(paquet);
				message = new String(buffer);
				switch(message.charAt(0)) {
				case 'i':
					inscription();
					break;
				case 'a':
					acquittement();
					break;
				case 'f':
					terminer();
					break;
				}
				verifierPretAEnvoyer();
				verifierFini();
				compteur++;
				affichageEtat();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}

	private static void affichageEtat() {
		for(int i =0; i <listeClient.size(); i++) {
			System.out.println("Client :" + listeClient.get(i).getAdresseIp()
							 + "Etat Fini :" + listeClient.get(i).isFini());
		}
	}

	private static void terminer() {
		for(int i=0; i < listeClient.size(); i++) {
			if(listeClient.get(i).getAdresseIp().equals(paquet.getAddress())) {
				listeClient.get(i).setFini(true);
			}
		}
	}

	private static void verifierPretAEnvoyer() throws IOException{
		System.out.println("Verification pret a envoyer");
		for(int i=0; i < listeClient.size(); i++) {
			if(listeClient.get(i).isPretAenvoyer()) {
				System.out.println("Pret a envoyer :" + listeClient.get(i).getAdresseIp());
				envoyer(listeClient.get(i),listeClient.get(i).getAdresseIp());
			}
		}
	}

	private static void envoyer(Client client,InetAddress adresseIp)  throws IOException{
		int port = 4523;
		String msg = client.getReponse();
		//TODO preparer requete et decouper
		System.out.println("Message a envoye : " + msg);
		socket.send(new DatagramPacket(msg.getBytes(), msg.getBytes().length,
					adresseIp, port));
		client.setFini(true);
		//si tous les ack ok
		
	}

	private static void verifierFini() {
		System.out.println("Verification fini");
		for(int i=0; i < listeClient.size(); i++) {
			if(listeClient.get(i).isFini()) {
				System.out.println("Client fini :" + listeClient.get(i).getAdresseIp());
				listeClient.remove(i);
			}
		}
		
	}

	private static void traiterClient() {
		System.out.println("Creation thread");
		comptThread+=1;
		new Service(""+comptThread);
	}


	public static void inscription() {
		System.out.println("Message recu :" + message);
		String[] decomp = message.split("\\|");
		System.out.println("Message apres decomposition :" + decomp[1]);
		listeClient.add(new Client(paquet.getAddress(),decomp[1]));
		//TODO repondre ACK
	}

	public static void acquittement() throws IOException{
		//23/02/2020 18:00:00
	}
}
